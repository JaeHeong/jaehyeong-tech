generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String?    // Optional for OAuth users
  googleId  String?    @unique // Google OAuth ID
  name      String
  avatar    String?
  bio       String?
  title     String?    // Job title
  github    String?
  twitter   String?
  linkedin  String?
  website   String?
  role      Role       @default(USER)
  status    UserStatus @default(ACTIVE)
  posts     Post[]
  drafts    Draft[]
  pages     Page[]
  comments  Comment[]
  likes     Like[]
  bookmarks Bookmark[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@map("users")
}

model Post {
  id          String     @id @default(cuid())
  slug        String     @unique
  title       String
  excerpt     String
  content     String
  coverImage  String?
  viewCount   Int        @default(0)
  likeCount   Int        @default(0)
  readingTime Int        @default(0)
  status      PostStatus @default(PUBLIC)
  featured    Boolean    @default(false)
  author      User       @relation(fields: [authorId], references: [id])
  authorId    String
  category    Category   @relation(fields: [categoryId], references: [id])
  categoryId  String
  tags        Tag[]
  images      Image[]
  likes       Like[]
  bookmarks   Bookmark[]
  views       PostView[]
  comments    Comment[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  publishedAt DateTime?

  @@index([slug])
  @@index([categoryId])
  @@index([authorId])
  @@index([status, createdAt])
  @@map("posts")
}

model Image {
  id         String   @id @default(cuid())
  url        String   // Full OCI URL
  objectName String   // OCI object path (e.g., "posts/xxx.jpg")
  filename   String   // Original filename
  size       Int      // File size in bytes
  mimetype   String   // MIME type
  folder     String   @default("posts") // Storage folder (posts, avatars)
  post       Post?    @relation(fields: [postId], references: [id], onDelete: SetNull)
  postId     String?
  createdAt  DateTime @default(now())

  @@index([postId])
  @@index([postId, createdAt])
  @@map("images")
}

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  color       String?
  posts       Post[]

  @@map("categories")
}

model Tag {
  id    String @id @default(cuid())
  name  String @unique
  slug  String @unique
  posts Post[]

  @@map("tags")
}

enum Role {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum PageType {
  STATIC
  NOTICE
}

enum PageStatus {
  DRAFT
  PUBLISHED
}

enum PostStatus {
  PUBLIC
  PRIVATE
}

model Page {
  id          String     @id @default(cuid())
  slug        String     @unique
  title       String
  type        PageType   @default(NOTICE)
  content     String     // Main content (markdown or HTML)
  excerpt     String?    // Short description for list view
  status      PageStatus @default(DRAFT)
  badge       String?    // Badge text (e.g., "필독", "안내", "업데이트")
  badgeColor  String?    // Badge color (e.g., "primary", "slate")
  isPinned    Boolean    @default(false)
  template    String?    // Template name for STATIC pages (e.g., "introduce", "privacy")
  viewCount   Int        @default(0)
  author      User       @relation(fields: [authorId], references: [id])
  authorId    String
  views       PageView[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  publishedAt DateTime?

  @@index([type, status])
  @@index([slug])
  @@index([isPinned, publishedAt])
  @@map("pages")
}

model PageView {
  id        String   @id @default(cuid())
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  pageId    String
  ipHash    String   // Hashed IP for unique view tracking
  createdAt DateTime @default(now())

  @@unique([pageId, ipHash])
  @@index([pageId])
  @@map("page_views")
}

model Like {
  id        String   @id @default(cuid())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String?  // For logged-in users
  ipHash    String?  // For anonymous users (hashed IP)
  createdAt DateTime @default(now())

  @@unique([postId, userId])   // One like per user per post
  @@unique([postId, ipHash])   // One like per IP per post (for anonymous)
  @@index([postId])
  @@index([userId])
  @@map("likes")
}

model Bookmark {
  id        String   @id @default(cuid())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())

  @@unique([postId, userId])   // One bookmark per user per post
  @@index([postId])
  @@index([userId])
  @@map("bookmarks")
}

model PostView {
  id        String   @id @default(cuid())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  ipHash    String   // Hashed IP for unique view tracking
  createdAt DateTime @default(now())

  @@unique([postId, ipHash])
  @@index([postId])
  @@map("post_views")
}

model Comment {
  id            String    @id @default(cuid())
  content       String
  post          Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId        String
  // Logged-in user (optional)
  author        User?     @relation(fields: [authorId], references: [id], onDelete: SetNull)
  authorId      String?
  // Anonymous user info
  guestName     String?
  guestPassword String?   // Hashed password for edit/delete
  // Reply support
  parent        Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  parentId      String?
  replies       Comment[] @relation("CommentReplies")
  // Visibility
  isPrivate     Boolean   @default(false) // Only visible to admin and comment author
  isDeleted     Boolean   @default(false) // Soft delete
  // Metadata
  ipHash        String?   // For spam prevention
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([postId, createdAt])
  @@index([parentId])
  @@index([authorId])
  @@map("comments")
}

model Draft {
  id         String    @id @default(cuid())
  title      String?   // Optional - can save without title
  content    String    @default("")
  excerpt    String?
  coverImage String?
  categoryId String?   // Optional - select when publishing
  tagIds     String[]  // Tag IDs array (simplified)
  author     User      @relation(fields: [authorId], references: [id])
  authorId   String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([authorId])
  @@index([updatedAt])
  @@map("drafts")
}
