apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: msa-services
data:
  kong.yml: |
    _format_version: "3.0"

    # Services and Routes
    services:
      # Auth Service
      - name: auth-service
        url: http://auth-service:3001
        routes:
          - name: auth-routes
            paths:
              - /api/auth
              - /api/tenants
              - /api/users
            strip_path: false

      # Comment Service
      - name: comment-service
        url: http://comment-service:3002
        routes:
          - name: comment-routes
            paths:
              - /api/comments
            strip_path: false

      # Storage Service
      - name: storage-service
        url: http://storage-service:3003
        routes:
          - name: storage-routes
            paths:
              - /api/files
            strip_path: false

      # Blog Service
      - name: blog-service
        url: http://blog-service:3003
        routes:
          - name: blog-routes
            paths:
              - /api/posts
              - /api/categories
              - /api/tags
              - /api/bookmarks
            strip_path: false

      # Page Service
      - name: page-service
        url: http://page-service:3004
        routes:
          - name: page-routes
            paths:
              - /api/pages
              - /api/notices
            strip_path: false

      # Analytics Service
      - name: analytics-service
        url: http://analytics-service:3005
        routes:
          - name: analytics-routes
            paths:
              - /api/visitors
              - /api/bug-reports
            strip_path: false

    # Global Plugins
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - Authorization
            - X-Tenant-Name
            - X-Tenant-ID
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600

      - name: request-transformer
        config:
          add:
            headers:
              - X-Forwarded-For:$remote_addr

      # Rate limiting (global)
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          policy: local
