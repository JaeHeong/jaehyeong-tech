# Istio AuthorizationPolicy - 서비스 간 접근 제어
# JWT 인증 강제 + 서비스별 접근 제어
---
# Auth Service - 공개 엔드포인트 (로그인, 회원가입 등)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: auth-service-policy
  namespace: jaehyeong-tech-dev
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
    # Health check - JWT 없이 허용
    - to:
        - operation:
            paths: ["/health", "/ready", "/.well-known/jwks.json"]
    # 공개 인증 엔드포인트 - JWT 없이 허용
    - to:
        - operation:
            paths: ["/auth/login", "/auth/register", "/auth/google", "/auth/google/callback", "/auth/refresh"]
            methods: ["POST", "GET"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
    # 내부 서비스 통신 - JWT 필수
    - from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
            requestPrincipals: ["*"]
---
# Blog Service - JWT 필수 (읽기는 공개)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: blog-service-policy
  namespace: jaehyeong-tech-dev
spec:
  selector:
    matchLabels:
      app: blog-service
  action: ALLOW
  rules:
    # Health check - JWT 없이 허용
    - to:
        - operation:
            paths: ["/health", "/ready"]
    # GET 요청 (공개 읽기) - JWT 없이 허용
    - to:
        - operation:
            methods: ["GET"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
    # 쓰기 작업 (POST, PUT, DELETE) - JWT 필수
    - to:
        - operation:
            methods: ["POST", "PUT", "PATCH", "DELETE"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
            requestPrincipals: ["*"]
---
# Comment Service - JWT 필수 (읽기는 공개)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: comment-service-policy
  namespace: jaehyeong-tech-dev
spec:
  selector:
    matchLabels:
      app: comment-service
  action: ALLOW
  rules:
    # Health check - JWT 없이 허용
    - to:
        - operation:
            paths: ["/health", "/ready"]
    # GET 요청 (공개 읽기) - JWT 없이 허용
    - to:
        - operation:
            methods: ["GET"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
    # 쓰기 작업 - JWT 필수
    - to:
        - operation:
            methods: ["POST", "PUT", "PATCH", "DELETE"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
            requestPrincipals: ["*"]
---
# Storage Service - JWT 필수
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: storage-service-policy
  namespace: jaehyeong-tech-dev
spec:
  selector:
    matchLabels:
      app: storage-service
  action: ALLOW
  rules:
    # Health check - JWT 없이 허용
    - to:
        - operation:
            paths: ["/health", "/ready"]
    # 파일 조회 (GET) - JWT 없이 허용 (공개 파일 접근)
    - to:
        - operation:
            methods: ["GET"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
    # 파일 업로드/삭제 - JWT 필수
    - to:
        - operation:
            methods: ["POST", "PUT", "DELETE"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
            requestPrincipals: ["*"]
---
# Page Service - JWT 필수 (읽기는 공개)
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: page-service-policy
  namespace: jaehyeong-tech-dev
spec:
  selector:
    matchLabels:
      app: page-service
  action: ALLOW
  rules:
    # Health check - JWT 없이 허용
    - to:
        - operation:
            paths: ["/health", "/ready"]
    # GET 요청 (공개 읽기) - JWT 없이 허용
    - to:
        - operation:
            methods: ["GET"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
    # 쓰기 작업 - JWT 필수
    - to:
        - operation:
            methods: ["POST", "PUT", "PATCH", "DELETE"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
            requestPrincipals: ["*"]
---
# Analytics Service - 쓰기는 공개 (방문자 추적), 읽기는 JWT 필수
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: analytics-service-policy
  namespace: jaehyeong-tech-dev
spec:
  selector:
    matchLabels:
      app: analytics-service
  action: ALLOW
  rules:
    # Health check - JWT 없이 허용
    - to:
        - operation:
            paths: ["/health", "/ready"]
    # 방문자 추적 POST - JWT 없이 허용 (익명 사용자도 추적)
    - to:
        - operation:
            paths: ["/analytics/visit", "/analytics/pageview", "/bug-reports"]
            methods: ["POST"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
    # 분석 데이터 조회 - JWT 필수 (관리자만)
    - to:
        - operation:
            methods: ["GET"]
      from:
        - source:
            namespaces: ["jaehyeong-tech-dev", "istio-system"]
            requestPrincipals: ["*"]
