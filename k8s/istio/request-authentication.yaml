# Istio RequestAuthentication - JWT 검증 설정
# Auth Service에서 발급한 JWT를 Istio에서 검증
# 참고: 실제 JWT 발급자(issuer)와 JWKS 엔드포인트 설정 필요
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: jaehyeong-tech-dev
spec:
  # 모든 워크로드에 적용 (selector 생략 시)
  jwtRules:
    - issuer: "auth-service"  # JWT 발급자 (auth-service에서 설정한 issuer와 일치해야 함)
      # JWKS 엔드포인트 - auth-service에서 공개 키를 가져옴
      jwksUri: "http://auth-service.jaehyeong-tech-dev.svc.cluster.local:3001/.well-known/jwks.json"
      # JWT가 없어도 요청 허용 (공개 API 지원)
      forwardOriginalToken: true
      # JWT에서 추출할 클레임을 헤더로 전달
      outputClaimToHeaders:
        - header: "x-user-id"
          claim: "sub"
        - header: "x-tenant-id"
          claim: "tenantId"
        - header: "x-user-email"
          claim: "email"
        - header: "x-user-role"
          claim: "role"
        - header: "x-tenant-name"
          claim: "tenantName"
---
# Auth Service는 JWT 검증에서 제외 (자체 인증 처리)
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: auth-service-skip-jwt
  namespace: jaehyeong-tech-dev
spec:
  selector:
    matchLabels:
      app: auth-service
  # 빈 jwtRules - JWT 검증 비활성화
  jwtRules: []
